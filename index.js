"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}function Path(e){return console.assert(e,"decorator must have arguments, like \"@path('/test/:test')\""),function(r,t){pathMap.set(r.constructor,{regexp:e,propertyKey:t})}}function initMap(){console.log("--init route--");var e=config$1.getConfig(),r=e.controllerDir,t=e.controllerSuffix,o=e.regexpFile,n=new RegExp("([a-zA-Z0-9_]+)"+t+".js");if(console.assert(fs.existsSync(r),"controller filepath may need to be set, default:"+r),fs.readdirSync(r).forEach(function(e){var t=e.match(n);if(t){console.log(e);var o=require(path.resolve(r,e)),a=Reflect.construct(o,[]);if(pathMap.has(o)){var i=pathMap.get(o),l=i.regexp,c=i.propertyKey;regexpMap.set(pathToRegexp(l),{instance:a,method:a[c]})}controllerMap.set(t[1].toLocaleLowerCase(),a)}}),o){var a=require(o);Object.keys(a).forEach(function(e){var r=a[e].slice(1).split("/");if(2===r.length){var t=slicedToArray(r,2),o=t[0],n=t[1],i=controllerMap.get(o);if(i){var l=i[n];l&&regexpMap.set(pathToRegexp(e),{instance:i,method:l})}}})}}function callMethod(e,r,t,o,n,a){e.ctx=o.app,e.req=o,e.res=n,e.next=a;var i=e.__before,l=e.__after,c=Promise.resolve();i&&(c=Promise.resolve(Reflect.apply(i,e,[]))),c.then(function(o){return!1!==o&&Reflect.apply(r,e,t)}).then(function(r){return!1!==r&&(l&&Reflect.apply(l,e,[]),r)}).catch(function(e){console.log(e)})}function pathRegexp(e,r,t){var o=!0,n=!1,a=void 0;try{for(var i,l=regexpMap[Symbol.iterator]();!(o=(i=l.next()).done);o=!0){var c=slicedToArray(i.value,2),p=c[0],f=c[1],s=p.exec(e.path);if(s)return callMethod(f.instance,f.method,s.slice(1),e,r,t),!0}}catch(e){n=!0,a=e}finally{try{!o&&l.return&&l.return()}finally{if(n)throw a}}return!1}function Router(e,r,t){if(controllerMap.size||initMap(),!pathRegexp(e,r,t)){var o=(e.path.slice(1)||"/index/index").split("/");if(o.length<2)return t();var n=toArray(o),a=n[0],i=n[1],l=n.slice(2);if(!i.indexOf("_"))return t();var c=controllerMap.get(a);if(!c)return t();var p=c[i];if(!p)return t();callMethod(c,p,l,e,r,t)}}Object.defineProperty(exports,"__esModule",{value:!0});var fs=_interopDefault(require("fs")),path=_interopDefault(require("path")),pathToRegexp=_interopDefault(require("path-to-regexp")),pathMap=new Map,process=require("process"),config={controllerDir:path.resolve(process.cwd(),"src/controller"),controllerSuffix:"Controller",regexpFile:null},config$1={setConfig:function(e){Object.assign(config,e)},getConfig:function(){return config}},slicedToArray=function(){function e(e,r){var t=[],o=!0,n=!1,a=void 0;try{for(var i,l=e[Symbol.iterator]();!(o=(i=l.next()).done)&&(t.push(i.value),!r||t.length!==r);o=!0);}catch(e){n=!0,a=e}finally{try{!o&&l.return&&l.return()}finally{if(n)throw a}}return t}return function(r,t){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return e(r,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),toArray=function(e){return Array.isArray(e)?e:Array.from(e)},regexpMap=new Map,controllerMap=new Map,setConfig=config$1.setConfig;exports.Path=Path,exports.Router=Router,exports.setConfig=setConfig;
